## Maximum Spherical Mean Value for Shadow Reduction (mSMV) <a id="msmv"> 

Here, an algorithm based on the maximum corollary of Greenâ€™s theorem is proposed to remove shadows in quantitative susceptibility mapping while preserving the edge of the brain. This method is referred to as maximum Spherical Mean Value, or `mSMV`.
<p align="center">
<img width="500" src=https://github.com/agr78/mSMV/assets/69256818/3d619d71-2fae-48cc-b7ad-8bdd4d78024f>
</p>
Residual background field is a major source of shadow artifacts in QSM. The algorithm filters large field magnitude values near the border, where the extreme values of the harmonic background field are located. Further details can be found in <a href="#publications" onclick="window.open('#publications', '_self');">Publications</a>.

## Installation
Clone the repository with:
`git clone https://github.com/agr78/mSMV.git`

## Function arguments
For ease of use with the [`MEDI Toolbox`](https://github.com/pascalspincemaille/MEDI_toolbox) (included in `mSMV/code/dependencies/MEDI_functions/`), the function `mSMV` accepts the following arguments: \
`in_file` Input file containing the field map after background field removal (by [`PDF`](https://sepia-documentation.readthedocs.io/en/latest/method/bfr/PDF.html), [`VSHARP`](https://sepia-documentation.readthedocs.io/en/latest/method/bfr/VSHARP_STISuite.html), [`LBV`](https://sepia-documentation.readthedocs.io/en/latest/method/bfr/LBV.html), etc.) \
`out_file` Output file containing <a href="#msmv" onclick="window.open('#msmv', '_self');">`mSMV`</a> filtered field map \
`radius` Prefilter radius (default 5mm) \
`maxk` Maximum number of iterations with minimum kernel radius (default 5) \
`vr` Frangi filter vessel radius, see MATLAB's [`fibermetric`](https://www.mathworks.com/help/images/ref/fibermetric.html) function for further details \
`pf` Optional disabling of the prefilter step (typically used with [`SHARP`](https://sepia-documentation.readthedocs.io/en/latest/method/bfr/SHARP.html), [`RESHARP`](https://sepia-documentation.readthedocs.io/en/latest/method/bfr/RESHARP.html), [`VSHARP`](https://sepia-documentation.readthedocs.io/en/latest/method/bfr/VSHARP_STISuite.html), etc.)

## Prerequisites
All necessary toolboxes are included in `mSMV/code/dependencies/`. If these toolboxes are already installed, `mSMV/code/mSMV_functions/` can be added to the MATLAB path.

## Examples
If an installation of [`MEDI`](https://github.com/pascalspincemaille/MEDI_toolbox) already exists, pull the `msmv` branch and modify the QSM reconstruction as follows:
```
QSM = MEDI_L1('filename', 'RDF.mat', 'lambda', 1000, 'merit', 'msmv');
```
If starting from a simple clone of this repository, run:
```
% Import complex field data
[iField,voxel_size,matrix_size,CF,delta_TE,TE,B0_dir,files]=Read_DICOM('DICOM');

% Generate the magnitude image 
iMag = squeeze(sqrt(sum(abs(iField).^2,4)));

% Compute brain mask
Mask = BET(iMag,matrix_size,voxel_size);

% Estimate noise and normalize field
if (~exist('noise_level','var'))
    noise_level = calfieldnoise(iField, Mask);
end
iField = iField/noise_level;

% Estimate the frequency offset in each of the voxel using complex fitting 
[iFreq_raw,N_std] = Fit_ppm_complex(iField);

% CSF zero-reference
Mask_CSF = extract_CSF(R2s,Mask,voxel_size);

% Unwrap phase using ROMEO
iFreq = romeo(iFreq_raw, iMag, Mask);

% Background field removal
[RDF,shim] = PDF(iFreq,N_std,Mask,matrix_size,voxel_size,B0_dir,0,100);

% Save local field generated by PDF
save RDF.mat RDF iFreq iFreq_raw iMag N_std Mask matrix_size...
     voxel_size delta_TE CF B0_dir Mask_CSF R2s;

% Reconstruct QSM
QSM = MEDI_L1('filename', 'RDF.mat', 'lambda', 1000, 'merit', 'msmv', 5);
```
The `run_simulation.m` file can be used to generate the numerical phantom from the [paper](https://arxiv.org/abs/2304.11476).

## Notes
The vessel mask requires an $R_2^*$ map for generation, if this variable is missing in `in_file`, this step will be skipped. \
The default phase unwrapping algorithm is [`ROMEO`](https://github.com/korbinian90/ROMEO), called from a MATLAB [`mex`](https://www.mathworks.com/help/matlab/ref/mex.html) file compiled on Windows 10. On different operating systems, `unwrapPhase.m` will be used.


## Publications
If this code is used, please cite the following:
> [Magnetic Resonance in Medicine Article](https://onlinelibrary.wiley.com/doi/10.1002/mrm.29963): A. G. Roberts et al., "Maximum Spherical Mean Value (mSMV) Filtering for Whole Brain Quantitative Susceptibility Mapping," Magnetic Resonance in Medicine, 2024, DOI: 10.1002/mrm.29963
> 
> [Preprint](https://arxiv.org/abs/2304.11476): A. G. Roberts et al., "Maximum Spherical Mean Value (mSMV) Filtering for Whole Brain Quantitative Susceptibility Mapping," arXiv pre-print server, 2023-04-22 2023, arxiv:2304.11476

## Contact
Please direct questions to [Alexandra Roberts](https://github.com/agr78) at agr78@cornell.edu.
